---
description: "Controller クラス設計書 - コントローラーの実装仕様とガイドライン"
globs: ["**/Controllers/**", "**/*Controller.php", "**/Http/Controllers/**"]
alwaysApply: false
---

# Controller クラス設計書

## 目次

1. [Controller 一覧](#controller一覧)
2. [Controller 詳細](#controller詳細)

---

## Controller 一覧

| 名称                  | アクション | 処理             | 説明                                                       |
| --------------------- | ---------- | ---------------- | ---------------------------------------------------------- |
| AuthController.php    | register   | ユーザー登録     | Firebase 認証後にユーザー情報を取得し、$user に格納する    |
| UserController.php    | show       | ユーザー取得     | 現在のログインユーザー情報を取得し、$user に格納する       |
| PostController.php    | index      | 投稿一覧取得     | 投稿一覧を取得し、$posts に格納する                        |
| PostController.php    | store      | 投稿作成         | リクエストから投稿内容を取得し、$post に格納する           |
| PostController.php    | show       | 投稿取得         | 指定された投稿を取得し、$post に格納する                   |
| PostController.php    | destroy    | 投稿削除         | 指定された投稿を取得し、$post に格納する                   |
| LikeController.php    | toggleLike | いいね切り替え   | 指定された投稿のいいね情報を取得し、$like に格納する       |
| CommentController.php | index      | コメント一覧取得 | 指定された投稿のコメント一覧を取得し、$comments に格納する |
| CommentController.php | store      | コメント作成     | リクエストからコメント内容を取得し、$comment に格納する    |

---

## Controller 詳細

### AuthController.php

#### register

| 項目       | 内容                                                                                                                                                                                                                                                                                 |
| ---------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| アクション | register                                                                                                                                                                                                                                                                             |
| 処理       | ユーザー登録                                                                                                                                                                                                                                                                         |
| 説明       | Firebase 認証後にユーザー情報を取得し、$userに格納する。リクエストからfirebase_uid、user_name、emailを取得し、バリデーションを実行する。バリデーション成功後、Userモデルを使用してユーザー情報をデータベースに登録し、$user に格納する。登録成功時は JSON 形式でユーザー情報を返す。 |

---

### UserController.php

#### show

| 項目       | 内容                                                                                                                                                                                                          |
| ---------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| アクション | show                                                                                                                                                                                                          |
| 処理       | ユーザー取得                                                                                                                                                                                                  |
| 説明       | 現在のログインユーザー情報を取得し、$userに格納する。認証ミドルウェアにより取得されたユーザーIDを使用して、Userモデルからユーザー情報を取得し、$user に格納する。取得成功時は JSON 形式でユーザー情報を返す。 |

---

### PostController.php

#### index

| 項目       | 内容                                                                                                                                                                                                                                                              |
| ---------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| アクション | index                                                                                                                                                                                                                                                             |
| 処理       | 投稿一覧取得                                                                                                                                                                                                                                                      |
| 説明       | 投稿一覧を取得し、$postsに格納する。Postモデルを使用して、ユーザー情報、いいね数、コメント数をEager Loadingで取得し、作成日時の降順でソートする。ページネーションに対応し、クエリパラメータのpageを使用する。取得した投稿一覧を$posts に格納し、JSON 形式で返す。 |

#### store

| 項目       | 内容                                                                                                                                                                                                                                                                                  |
| ---------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| アクション | store                                                                                                                                                                                                                                                                                 |
| 処理       | 投稿作成                                                                                                                                                                                                                                                                              |
| 説明       | リクエストから投稿内容を取得し、$postに格納する。リクエストからcontentを取得し、バリデーションを実行する（必須、120文字以内）。バリデーション成功後、認証済みユーザーのIDと投稿内容を使用してPostモデルで新規投稿を作成し、$post に格納する。作成成功時は JSON 形式で投稿情報を返す。 |

#### show

| 項目       | 内容                                                                                                                                                                                                                                                                        |
| ---------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| アクション | show                                                                                                                                                                                                                                                                        |
| 処理       | 投稿取得                                                                                                                                                                                                                                                                    |
| 説明       | 指定された投稿を取得し、$postに格納する。リクエストパラメータから投稿IDを取得し、Postモデルから該当投稿をユーザー情報、いいね数、コメント数と共にEager Loadingで取得して$post に格納する。投稿が存在しない場合は 404 エラーを返す。取得成功時は JSON 形式で投稿情報を返す。 |

#### destroy

| 項目       | 内容                                                                                                                                                                                                                                                                                                                                   |
| ---------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| アクション | destroy                                                                                                                                                                                                                                                                                                                                |
| 処理       | 投稿削除                                                                                                                                                                                                                                                                                                                               |
| 説明       | 指定された投稿を取得し、$postに格納する。リクエストパラメータから投稿IDを取得し、Postモデルから該当投稿を取得して$post に格納する。投稿が存在しない場合は 404 エラーを返す。投稿者のみ削除可能なため、認証済みユーザー ID と投稿の user_id を比較し、一致しない場合は 403 エラーを返す。削除成功時は JSON 形式で成功メッセージを返す。 |

---

### LikeController.php

#### toggleLike

| 項目       | 内容                                                                                                                                                                                                                                                                                                                                                    |
| ---------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| アクション | toggleLike                                                                                                                                                                                                                                                                                                                                              |
| 処理       | いいね切り替え                                                                                                                                                                                                                                                                                                                                          |
| 説明       | 指定された投稿のいいね情報を取得し、$likeに格納する。リクエストパラメータから投稿IDを取得し、Postモデルから該当投稿を取得して$post に格納する。認証済みユーザー ID と投稿 ID を使用して、Like モデルから既存のいいね情報を検索し、$likeに格納する。$like が存在する場合は削除し、存在しない場合は新規作成する。トグル後のいいね状態を JSON 形式で返す。 |

---

### CommentController.php

#### index

| 項目       | 内容                                                                                                                                                                                                                                                                                                                                                                           |
| ---------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| アクション | index                                                                                                                                                                                                                                                                                                                                                                          |
| 処理       | コメント一覧取得                                                                                                                                                                                                                                                                                                                                                               |
| 説明       | 指定された投稿のコメント一覧を取得し、$commentsに格納する。リクエストパラメータから投稿IDを取得し、Postモデルから該当投稿を取得して$post に格納する。$postが存在しない場合は404エラーを返す。Commentモデルを使用して、該当投稿のコメント一覧をユーザー情報と共にEager Loadingで取得し、作成日時の昇順でソートする。取得したコメント一覧を$comments に格納し、JSON 形式で返す。 |

#### store

| 項目       | 内容                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| ---------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| アクション | store                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| 処理       | コメント作成                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| 説明       | リクエストからコメント内容を取得し、$commentに格納する。リクエストパラメータから投稿IDを取得し、Postモデルから該当投稿を取得して$post に格納する。$postが存在しない場合は404エラーを返す。リクエストからcontentを取得し、バリデーションを実行する（必須、120文字以内）。バリデーション成功後、認証済みユーザーのID、投稿ID、コメント内容を使用してCommentモデルで新規コメントを作成し、$comment に格納する。作成成功時は JSON 形式でコメント情報を返す。 |

---

## 共通処理

### バリデーション

各コントローラのアクションでは、以下のバリデーションルールを適用します：

- **AuthController::register**: `firebase_uid`（必須）、`user_name`（必須、20 文字以内）、`email`（必須、メール形式、ユニーク）
- **PostController::store**: `content`（必須、120 文字以内）
- **CommentController::store**: `content`（必須、120 文字以内）

### 認証・認可

以下のアクションでは認証が必須です：

- **UserController::show**: 認証済みユーザーのみアクセス可能
- **PostController::store**: 認証済みユーザーのみ投稿可能
- **PostController::destroy**: 認証済みユーザーかつ投稿者のみ削除可能
- **LikeController::toggleLike**: 認証済みユーザーのみいいね可能
- **CommentController::store**: 認証済みユーザーのみコメント可能

### エラーハンドリング

各アクションでは、以下のエラーハンドリングを実装します：

- **バリデーションエラー**: 422 ステータスコードとエラーメッセージを返す
- **認証エラー**: 401 ステータスコードとエラーメッセージを返す
- **認可エラー**: 403 ステータスコードとエラーメッセージを返す
- **リソース不存在エラー**: 404 ステータスコードとエラーメッセージを返す
- **サーバーエラー**: 500 ステータスコードとエラーメッセージを返す

---

## 命名規則

本プロジェクトでは、以下の命名規則に従います：

- **Controller ファイル名**: 単数形、パスカルケース（例: `PostController.php`, `CommentController.php`）
- **アクション名**: キャメルケース（例: `index`, `store`, `toggleLike`）
- **変数名**: スネークケース（例: `$user`, `$post`, `$comment`）

この規則により、Laravel の規約に従いながら、プロジェクトの一貫性を保ちます。
